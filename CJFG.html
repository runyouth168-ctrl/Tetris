<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CYBER TETRIS - FINAL AVATAR</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@900&family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&family=Pacifico&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- ä¸»é¢˜ç³»ç»Ÿ --- */
        :root {
            --bg-color: #050510;
            --primary: #00f3ff;
            --accent: #ff0055;
            --glass: rgba(20, 30, 40, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --font-current: 'Orbitron', sans-serif;
        }

        body[data-theme="retro"] { --bg-color: #2b2b2b; --primary: #00ff00; --accent: #ff9900; --glass: rgba(0,0,0,0.9); --glass-border: #00ff00; }
        body[data-theme="forest"] { --bg-color: #0a1f0a; --primary: #00ff88; --accent: #ffdd00; --glass: rgba(10,40,20,0.9); --glass-border: rgba(255,255,255,0.3); }
        body[data-theme="candy"] { --bg-color: #2a0a18; --primary: #ff69b4; --accent: #00ffff; --glass: rgba(50,20,40,0.9); --glass-border: rgba(255,182,193,0.5); }
        body[data-theme="dark"] { --bg-color: #000000; --primary: #888888; --accent: #ffffff; --glass: rgba(20,20,20,0.95); --glass-border: #444; }
        body[data-theme="light"] { --bg-color: #f0f0f0; --primary: #007bff; --accent: #ff4500; --glass: rgba(255,255,255,0.95); --glass-border: #ccc; }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 100%);
            color: #fff;
            font-family: var(--font-current);
            overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
            perspective: 1000px;
            transition: font-family 0.3s;
        }

        /* å¯åŠ¨ç•Œé¢ */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 30000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s;
        }
        .title-group { text-align: center; margin-bottom: 40px; animation: textFloat 3s ease-in-out infinite; }
        
        .title-cn {
            font-family: 'ZCOOL KuaiLe', cursive; 
            font-size: 80px; font-weight: 900; color: #ffd700;
            transform: perspective(600px) rotateX(20deg);
            text-shadow: 
                1px 1px 0 #ff0055, 2px 2px 0 #ff0055, 3px 3px 0 #ff0055, 
                4px 4px 0 #ff0055, 5px 5px 0 #ff0055, 0 50px 30px rgba(0,0,0,0.6);
            letter-spacing: 5px;
        }
        
        #start-btn {
            background: transparent; color: var(--primary); border: 2px solid var(--primary);
            padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px var(--primary); border-radius: 5px; font-family: inherit;
            transition: 0.3s; pointer-events: auto; position: relative; z-index: 30001;
        }
        #start-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }

        .boot-author-box { display: flex; align-items: center; gap: 10px; margin-top: 40px; }
        
        /* ä¿®æ”¹ï¼šå¯åŠ¨é¡µå¤´åƒæ ·å¼ */
        .author-avatar-img {
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid var(--primary);
            box-shadow: 0 0 8px var(--primary);
            object-fit: cover; /* å…³é”®ï¼šé˜²æ­¢å›¾ç‰‡å˜å½¢ */
            display: block;
            background: #000;
        }
        .boot-author-text { font-family: 'ZCOOL KuaiLe', cursive; font-size: 16px; color: #aaa; text-shadow: 0 0 5px var(--primary); letter-spacing: 1px; }

        .loader-container { width: 80%; max-width: 300px; display: none; flex-direction: column; align-items: center; margin-top: 20px; }
        .progress-bar-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.1s linear; }
        .loading-text { font-size: 12px; color: var(--primary); margin-top: 10px; letter-spacing: 2px; }

        /* UIç»„ä»¶ */
        #dashboard {
            height: 60px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 10px; background: rgba(0,0,0,0.5); border-bottom: 1px solid #333;
            z-index: 50; position: relative;
        }
        .panel {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 6px; padding: 2px 8px; text-align: center; min-width: 70px;
        }
        .p-label { font-size: 10px; color: #aaa; }
        .p-value { font-size: 16px; color: var(--primary); }

        #next-box {
            position: absolute; top: 75px; right: 8px;
            width: 60px; height: 70px;
            background: transparent; border: none;
            border-radius: 6px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 5; pointer-events: none;
        }
        #next-label { font-size: 9px; color: #aaa; margin-bottom: 2px; }
        #next-canvas { width: 50px; height: 50px; display: block; }

        /* ä¾§è¾¹èœå• */
        .side-menu {
            display: none;
            position: fixed; top: 250px; right: 2px;
            flex-direction: column; gap: 20px; 
            z-index: 999999;
        }
        .menu-icon {
            width: 45px; height: 45px; background: var(--glass);
            border: 2px solid var(--primary); border-radius: 50%; color: #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; box-shadow: 0 0 15px var(--primary);
            transition: transform 0.1s; pointer-events: auto; touch-action: manipulation;
        }
        .menu-icon:active { transform: scale(0.9); background: var(--primary); color: #000; }

        #game-area {
            flex: 1; position: relative;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; z-index: 1;
        }
        canvas {
            background: rgba(0, 0, 0, 0.8); border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            width: 300px; height: 600px; max-height: 96%; max-width: 95%; display: block;
        }
        body.mode-3d canvas { transform: perspective(800px) rotateX(20deg) scale(0.9); }

        /* åº•éƒ¨æ§åˆ¶åŒº */
        #controls {
            height: 240px; flex-shrink: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            position: relative; z-index: 100;
        }
        body.layout-editing #controls { background: rgba(0,0,0,0.8); border-top: 2px dashed var(--primary); }
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; height: 100%; padding: 0 30px; position: relative; }

        .draggable-item { position: relative; touch-action: none; }
        body.custom-layout .draggable-item { position: absolute; }
        body.layout-editing .draggable-item { border: 1px dashed rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); border-radius: 10px;}
        body.layout-editing .draggable-item.active-drag { border: 2px solid var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 1000; }

        .joystick-base {
            width: 120px; height: 120px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            border-radius: 50%;
        }
        .joystick-stick {
            width: 50px; height: 50px; background: var(--primary); border-radius: 50%;
            position: absolute; top: 35px; left: 35px;
            box-shadow: 0 0 15px var(--primary); pointer-events: none;
        }

        .btn-round {
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; pointer-events: auto; color: #fff;
        }
        .btn-round:active { background: #fff; color: #000; }
        .btn-icon { font-size: 24px; pointer-events: none; }

        /* æ‰‹å†™ä½“æ ‡è¯­ */
        .slogan-text {
            position: fixed; bottom: 50px; left: 0; width: 100%;
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
            font-weight: 300;
            font-size: 12px; 
            color: rgba(255, 255, 255, 0.7);
            letter-spacing: 2px; pointer-events: none; z-index: 200;
            text-shadow: none;
        }
        
        .author-footer {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            display: flex; justify-content: center; align-items: center; gap: 10px;
            color: #fff; font-size: 12px; font-weight: bold;
            pointer-events: none; z-index: 200;
            background: rgba(0, 0, 0, 0.6); padding: 5px 15px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* ä¿®æ”¹ï¼šåº•éƒ¨å°å¤´åƒæ ·å¼ */
        .footer-avatar {
            width: 24px; height: 24px; border-radius: 50%;
            border: 1px solid var(--primary);
            box-shadow: 0 0 5px var(--primary);
            object-fit: cover;
            display: block;
            background: #000;
        }

        /* å¸ƒå±€ç¼–è¾‘å™¨ UI */
        #layout-editor-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 15000; display: none; pointer-events: none;
        }
        .layout-editor-ui {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); border: 1px solid var(--primary);
            padding: 10px 20px; border-radius: 20px; pointer-events: auto; text-align: center;
        }
        .layout-tip { color: #fff; font-size: 12px; margin-bottom: 5px; text-shadow: 0 0 5px black;}

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 40000;
        }
        .modal-box {
            background: var(--bg-color); border: 2px solid var(--primary);
            padding: 20px; width: 90%; max-width: 360px; border-radius: 10px;
            text-align: center; color: var(--text-main); max-height: 90vh; overflow-y: auto;
            box-shadow: 0 0 20px var(--primary);
        }
        .modal-title { font-size: 20px; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; font-family: var(--font-current); }
        .setting-item { display: flex; justify-content: space-between; margin: 12px 0; font-size: 13px; align-items: center; }
        select { background: #333; color: #fff; border: 1px solid #555; padding: 5px; max-width: 140px; font-family: inherit; }
        .action-btn {
            width: 100%; padding: 10px; margin-top: 15px;
            background: var(--primary); color: #000; border: none; font-weight: bold;
            font-size: 16px; cursor: pointer; font-family: inherit;
        }

        .rules-list { text-align: left; padding: 0 5px; color: #ccc; }
        .rule-row { display: flex; align-items: flex-start; margin-bottom: 10px; font-size: 12px; line-height: 1.5; }
        .rule-title { width: 70px; flex-shrink: 0; color: var(--primary); font-weight: bold; margin-right: 5px; }
        .rule-desc { flex: 1; }

        .dpad-grid { display: none; grid-template-columns: 1fr 1fr 1fr; gap: 5px; width: 140px; }
        .dpad-btn { height: 45px; background: #333; border: 1px solid #555; color: #fff; display: flex; justify-content: center; align-items: center; border-radius: 5px; }
        
        .status-msg {
            position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; color: var(--accent); font-weight: bold;
            text-shadow: 0 0 20px #000; pointer-events: none; z-index: 6000;
            opacity: 0; transition: opacity 0.3s; font-family: 'ZCOOL KuaiLe', cursive;
        }
        #flash-overlay { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 5000; }
        .flashing { animation: flash 0.2s; }
        @keyframes flash { 0% { background: rgba(255,255,255,0); } 50% { background: rgba(255,255,255,0.5); } 100% { background: rgba(255,255,255,0); } }
        @keyframes textFloat { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    </style>
</head>
<body data-theme="cyber">

    <!-- å¯åŠ¨ç”»é¢ -->
    <div id="boot-screen">
        <div class="title-group">
            <div class="title-cn">è¶…çº§æ–¹å—</div>
        </div>
        <button id="start-btn">INIT SYSTEM</button>
        <div class="loader-container" id="loader">
            <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill"></div></div>
            <div class="loading-text">SYSTEM LOADING <span id="percent">0%</span></div>
        </div>
        <div class="boot-author-box">
            <!-- å¯åŠ¨é¡µå¤´åƒï¼šåœ¨æ­¤æ›¿æ¢ src -->
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0FpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDkuMS1jMDAzIDc5Ljk2OTBhODdmYywgMjAyNS8wMy8wNi0yMDo1MDoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI3LjAgKDIwMjUxMDEyLm0uMzI1NSBkOTcxZjgwKSAgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY4RTQzOTkxQ0JGQzExRjA4RkREOEQ4QzU5QjJCOEFDIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjY4RTQzOTkyQ0JGQzExRjA4RkREOEQ4QzU5QjJCOEFDIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NjhFNDM5OEZDQkZDMTFGMDhGREQ4RDhDNTlCMkI4QUMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NjhFNDM5OTBDQkZDMTFGMDhGREQ4RDhDNTlCMkI4QUMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tl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"/>
            <div class="boot-author-text">æ¸…æ™¨åˆ¶ä½œ â€– 2025</div>
        </div>
    </div>

    <!-- UIç»„ä»¶ (åŒè¯­) -->
    <div id="dashboard">
        <div class="panel"><div class="p-label">æ—¶é—´ TIME</div><div class="p-value" id="clock">00:00</div></div>
        <div class="panel"><div class="p-label">æœ€é«˜åˆ† BEST</div><div class="p-value gold" id="high-score">0</div></div>
        <div class="panel"><div class="p-label">å¾—åˆ† SCORE</div><div class="p-value" id="score">0</div></div>
        <div class="panel"><div class="p-label">æ¨¡å¼ MODE</div><div class="p-value" id="status-text">NORM</div></div>
    </div>

    <div id="next-box">
        <div id="next-label">ä¸‹ä¸ª NEXT</div>
        <canvas id="next-canvas" width="50" height="50"></canvas>
    </div>

    <!-- ä¾§è¾¹èœå• -->
    <div class="side-menu" style="display:none;">
        <div class="menu-icon" onclick="game.togglePause()" ontouchstart="event.stopPropagation()">â¸</div>
        <div class="menu-icon" onclick="ui.openSettings()" ontouchstart="event.stopPropagation()">âš™ï¸</div>
        <div class="menu-icon" onclick="ui.openRules()" ontouchstart="event.stopPropagation()">ğŸ“–</div>
        <div class="menu-icon" onclick="ui.openLevels()" ontouchstart="event.stopPropagation()">ğŸš©</div>
    </div>

    <div id="game-area">
        <canvas id="tetris" width="300" height="600"></canvas>
        <div id="msg-overlay" class="status-msg"></div>
    </div>
    <div id="flash-overlay"></div>

    <!-- æ§åˆ¶åŒº -->
    <div id="controls">
        <div class="ctrl-row" id="ctrl-container">
            <div class="joystick-base draggable-item" id="joystick" data-id="joy">
                <div class="joystick-stick" id="stick"></div>
            </div>
            
            <div class="dpad-grid draggable-item" id="dpad-controls" data-id="dpad">
                <div></div><div class="dpad-btn" id="btn-up">â†»</div><div></div>
                <div class="dpad-btn" id="btn-left">â†</div><div class="dpad-btn" id="btn-down">â†“</div><div class="dpad-btn" id="btn-right">â†’</div>
            </div>

            <div class="draggable-item" id="btn-rotate-wrap" data-id="rot">
                <div class="btn-round" id="btn-rotate"><span class="btn-icon">â†»</span>æ—‹è½¬</div>
            </div>
            <div class="draggable-item" id="btn-drop-wrap" data-id="drop">
                <div class="btn-round" id="btn-drop"><span class="btn-icon">â‡“</span>æ‰è½</div>
            </div>
        </div>
    </div>

    <div class="slogan-text">ç©ç€ä¿„ç½—æ–¯çš„æ–¹å—ï¼Œæƒ³ç€ä¿„ç½—æ–¯çš„å¦¹å­ğŸ‘±ğŸ»â€â™€ï¸</div>
    <div class="author-footer">
        <!-- åº•éƒ¨å¤´åƒï¼šåœ¨æ­¤æ›¿æ¢ src -->
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA0FpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDkuMS1jMDAzIDc5Ljk2OTBhODdmYywgMjAyNS8wMy8wNi0yMDo1MDoxNiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI3LjAgKDIwMjUxMDEyLm0uMzI1NSBkOTcxZjgwKSAgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY4RTQzOTkxQ0JGQzExRjA4RkREOEQ4QzU5QjJCOEFDIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjY4RTQzOTkyQ0JGQzExRjA4RkREOEQ4QzU5QjJCOEFDIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NjhFNDM5OEZDQkZDMTFGMDhGREQ4RDhDNTlCMkI4QUMiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NjhFNDM5OTBDQkZDMTFGMDhGREQ4RDhDNTlCMkI4QUMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tl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"/>
        <span>æ¸…æ™¨åˆ¶ä½œ</span>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="modal">
        <div class="modal-box">
            <div class="modal-title">ç³»ç»Ÿè®¾ç½® SETTINGS</div>
            <div class="setting-item"><span>æ“ä½œ CONTROLS</span><select id="opt-control" onchange="game.updateSettings()"><option value="joystick">æ‘‡æ† Joystick</option><option value="buttons">æŒ‰é”® Buttons</option></select></div>
            <div class="setting-item"><span>å¸ƒå±€ LAYOUT</span><button class="action-btn" style="margin:0; width:auto; font-size:12px; padding:5px 10px;" onclick="layoutSystem.startEdit()">ç¼–è¾‘ Edit</button></div>
            <div class="setting-item"><span>æ¨¡å¼ MODE</span><select id="opt-mode" onchange="game.setMode(this.value)">
                <option value="classic">ç»å…¸ Classic</option><option value="battle">å¯¹æˆ˜ Battle</option><option value="blind">ç›²æ¶ˆ Blind</option><option value="collection">æ”¶é›† Collect</option><option value="variant">å˜ç§ Variant</option><option value="3d">3D</option>
            </select></div>
            <div class="setting-item"><span>é£æ ¼ STYLE</span><select id="opt-style" onchange="game.setBlockStyle(this.value)"><option value="default">é»˜è®¤ Default</option><option value="magma">å²©æµ† Magma</option><option value="ice">å†°æ™¶ Ice</option><option value="brick">ç –å¢™ Brick</option><option value="mech">æœºæ¢° Mech</option></select></div>
            <div class="setting-item"><span>éŸ³æ•ˆ AUDIO</span><select id="opt-sound" onchange="sound.setPack(this.value)"><option value="scifi">ç§‘æŠ€ Sci-Fi</option><option value="8bit">8ä½æœº 8-Bit</option><option value="real">çœŸå® Real</option><option value="bubble">æ³¡æ³¡ Bubble</option><option value="mech">æœºæ¢° Mech</option><option value="piano">é’¢ç´ Piano</option></select></div>
            <div class="setting-item"><span>ç‰¹æ•ˆ VFX</span><select id="opt-vfx" onchange="game.setVfx(this.value)"><option value="thunder">é›·ç”µ Thunder</option><option value="explode">çˆ†ç ´ Explode</option><option value="match3">æ¶ˆæ¶ˆä¹ Match3</option></select></div>
            <div class="setting-item"><span>å­—ä½“ FONT</span><select id="opt-font" onchange="ui.updateFont(this.value)">
                <option value="'Orbitron', sans-serif">ç§‘æŠ€ (Orbitron)</option>
                <option value="'Press Start 2P', cursive">åƒç´  (Pixel)</option>
                <option value="'ZCOOL KuaiLe', cursive">å¿«ä¹ (KuaiLe)</option>
                <option value="'Playfair Display', serif">ä¼˜é›… (Serif)</option>
                <option value="'Ma Shan Zheng', cursive">æ‰‹å†™ (Hand)</option>
                <option value="'Roboto', sans-serif">æ ‡å‡† (Roboto)</option>
            </select></div>
            <div class="setting-item"><span>ä¸»é¢˜ THEME</span><select id="opt-theme" onchange="ui.updateTheme()"><option value="cyber">èµ›åš Cyber</option><option value="retro">å¤å¤ Retro</option><option value="forest">æ£®æ— Forest</option><option value="candy">ç³–æœ Candy</option><option value="dark">æš—é»‘ Dark</option><option value="light">ç™½æ˜¼ Light</option></select></div>
            <button class="action-btn" onclick="ui.closeAll()">ä¿å­˜ SAVE</button>
        </div>
    </div>

    <!-- è§„åˆ™å¼¹çª— -->
    <div id="rules-modal" class="modal">
        <div class="modal-box">
            <div class="modal-title">æ¸¸æˆè§„åˆ™ RULES</div>
            <div class="rules-list">
                <div class="rule-row"><div class="rule-title">ç»å…¸ Classic</div><div class="rule-desc">æ— å°½æŒ‘æˆ˜ï¼Œæ¶ˆé™¤å¾—åˆ†ã€‚Endless, score high.</div></div>
                <div class="rule-row"><div class="rule-title">å¯¹æˆ˜ Battle</div><div class="rule-desc">æ¨¡æ‹ŸPVPï¼Œäº’å‘åƒåœ¾è¡Œã€‚PVP simulation.</div></div>
                <div class="rule-row"><div class="rule-title">ç›²æ¶ˆ Blind</div><div class="rule-desc">æ–¹å—è½åœ°éšå½¢ã€‚Blocks hide after drop.</div></div>
                <div class="rule-row"><div class="rule-title">æ”¶é›† Collect</div><div class="rule-desc">é“å…·: ğŸ’åŠ åˆ† ğŸ’£ç‚¸å¼¹ â„ï¸å†»ç»“ ğŸŒˆå˜è‰²ã€‚Collect special items.</div></div>
                <div class="rule-row"><div class="rule-title">å˜ç§ Variant</div><div class="rule-desc">éšæœºå¼‚å¸¸çŠ¶æ€ã€‚Random status effects.</div></div>
                <div class="rule-row"><div class="rule-title">3D</div><div class="rule-desc">ç«‹ä½“è§†è§‰ä½“éªŒã€‚3D visual experience.</div></div>
                <div class="rule-row"><div class="rule-title">é—¯å…³ Levels</div><div class="rule-desc">100ä¸ªæ®‹å±€å…³å¡ã€‚100 puzzle levels.</div></div>
            </div>
            <button class="action-btn" onclick="ui.closeAll()">æˆ‘æ˜ç™½äº† OK</button>
        </div>
    </div>

    <!-- å…³å¡å¼¹çª— -->
    <div id="levels-modal" class="modal">
        <div class="modal-box">
            <div class="modal-title">é€‰å…³ LEVELS</div>
            <div class="grid-levels" id="level-list" style="display:grid; grid-template-columns:repeat(5,1fr); gap:5px; max-height:200px; overflow-y:auto;"></div>
            <button class="action-btn" onclick="ui.closeAll()">å…³é—­ CLOSE</button>
        </div>
    </div>

    <!-- ç»“æŸå¼¹çª— -->
    <div id="gameover-modal" class="modal">
        <div class="modal-box">
            <div class="modal-title" style="color:var(--accent)">GAME OVER</div>
            <div>å¾—åˆ† SCORE: <span id="final-score">0</span></div>
            <button class="action-btn" onclick="game.reset()">é‡è¯• RETRY</button>
        </div>
    </div>

    <!-- å¸ƒå±€ç¼–è¾‘å™¨ UI -->
    <div id="layout-editor-overlay">
        <div class="layout-editor-ui">
            <div class="layout-tip">é•¿æŒ‰æ‹–åŠ¨ Hold & Drag | åŒæŒ‡ç¼©æ”¾ Pinch Scale</div>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="action-btn" style="margin:0; padding:5px 15px; font-size:12px; background:var(--accent);" onclick="layoutSystem.resetDefault()">é‡ç½® RESET</button>
                <button class="action-btn" style="margin:0; padding:5px 15px; font-size:12px;" onclick="layoutSystem.saveAndExit()">ä¿å­˜é€€å‡º SAVE</button>
            </div>
        </div>
    </div>

    <script>
        // --- éŸ³æ•ˆç³»ç»Ÿ ---
        let audioCtx;
        const sound = {
            pack: 'scifi',
            init: () => {
                if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if(audioCtx.state === 'suspended') audioCtx.resume();
            },
            setPack: (val) => { sound.pack = val; },
            play: (type) => {
                if(!audioCtx) sound.init();
                const t = audioCtx.currentTime;
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                
                if (type === 'intro') {
                    const o1 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
                    o1.type = 'sawtooth'; o1.frequency.setValueAtTime(200, t); o1.frequency.exponentialRampToValueAtTime(800, t + 2.0);
                    g1.gain.setValueAtTime(0, t); g1.gain.linearRampToValueAtTime(0.5, t + 0.5); g1.gain.linearRampToValueAtTime(0, t + 3.0);
                    o1.connect(g1); g1.connect(audioCtx.destination); o1.start(t); o1.stop(t+3.0);
                    return;
                }

                let wave = 'sine';
                if (sound.pack === '8bit') wave = 'square';
                if (sound.pack === 'mech') wave = 'sawtooth';
                if (sound.pack === 'piano') wave = 'triangle';
                osc.type = wave;

                if (type === 'move') {
                    if(sound.pack==='mech') osc.frequency.setValueAtTime(100, t);
                    else osc.frequency.setValueAtTime(sound.pack==='8bit'?220:600, t);
                    gain.gain.setValueAtTime(0.05, t); gain.gain.linearRampToValueAtTime(0, t+0.05);
                    osc.start(t); osc.stop(t+0.05);
                } 
                else if (type === 'land') {
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(20, t+0.1);
                    gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
                    osc.start(t); osc.stop(t+0.1);
                } 
                else if (type === 'clear') {
                    [523, 659, 784].forEach((f,i)=>{
                        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
                        o.connect(g); g.connect(audioCtx.destination); o.type = wave; o.frequency.value=f; 
                        g.gain.setValueAtTime(0.1, t+i*0.05); g.gain.linearRampToValueAtTime(0, t+i*0.05 + 0.3);
                        o.start(t+i*0.05); o.stop(t+i*0.05+0.3);
                    });
                } 
            }
        };

        const COLS = 10, ROWS = 20;
        const COLORS = [null, '#00f3ff', '#0055ff', '#ffaa00', '#ffea00', '#00ff66', '#bc13fe', '#ff0055'];
        const SHAPES = [ [], [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], [[2,0,0],[2,2,2],[0,0,0]], [[0,0,3],[3,3,3],[0,0,0]], [[4,4],[4,4]], [[0,5,5],[5,5,0],[0,0,0]], [[0,6,0],[6,6,6],[0,0,0]], [[7,7,0],[0,7,7],[0,0,0]] ];

        class Game {
            constructor() {
                this.canvas = document.getElementById('tetris');
                this.ctx = this.canvas.getContext('2d');
                this.nextCanvas = document.getElementById('next-canvas');
                this.nextCtx = this.nextCanvas.getContext('2d');
                this.board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
                this.particles = [];
                this.score = 0; this.level = 1; this.mode = 'classic';
                this.vfxMode = 'thunder'; this.blockStyle = 'default'; 
                this.paused = false; this.gameOver = false;
                this.dropInterval = 1000; this.dropCounter = 0; this.lastTime = 0;
                this.canvas.width = 300; this.canvas.height = 600;
                this.variantTimer = 0; this.canRotate = true; this.currentLevel = 1;

                this.initInput();
                this.reset();
                requestAnimationFrame(this.update.bind(this));
            }

            reset(mode = this.mode) {
                this.board = Array.from({length: ROWS}, () => Array(COLS).fill(0));
                this.score = 0; this.level = 1; this.gameOver = false; this.mode = mode;
                this.paused = false; this.canRotate = true;
                this.particles = [];
                
                if(this.mode === '3d') document.body.classList.add('mode-3d');
                else document.body.classList.remove('mode-3d');

                if(this.mode === 'puzzle') this.initPuzzle(this.currentLevel);
                
                this.nextPiece = this.randomPiece();
                this.spawnPiece();
                this.updateUI();
                document.getElementById('gameover-modal').style.display = 'none';
            }

            initPuzzle(lvl) {
                let h = Math.min(14, 3 + Math.floor(lvl / 8));
                let pattern = lvl % 5;
                for(let y = ROWS - h; y < ROWS; y++) {
                    for(let x = 0; x < COLS; x++) {
                        let fill = 0;
                        if(pattern === 0) fill = (x % 2 === y % 2) ? 1 : 0;
                        else if(pattern === 1) fill = (x % 3 === 0) ? 1 : 0;
                        else if(pattern === 2) fill = ((x+y) % 3 === 0) ? 1 : 0;
                        else if(pattern === 3) fill = (x > 2 && x < 7) ? 1 : 0;
                        else if(pattern === 4) fill = (Math.random() > 0.4) ? 1 : 0;
                        if(lvl % 10 === 0) { if(x === 4 || x === 5) fill = 0; else fill = 1; }
                        if(fill) this.board[y][x] = Math.floor(Math.random()*7)+1;
                    }
                }
            }

            randomPiece() {
                const id = Math.floor(Math.random()*7)+1;
                const p = { matrix: JSON.parse(JSON.stringify(SHAPES[id])), color: id, type: 'normal' };
                if(this.mode === 'collection' && Math.random()<0.2) {
                    const r = Math.random();
                    if(r<0.25) p.type='bomb'; else if(r<0.5) p.type='diamond'; 
                    else if(r<0.75) p.type='freeze'; else p.type='color';
                }
                return p;
            }

            spawnPiece() {
                this.piece = this.nextPiece;
                this.piece.x = 3; this.piece.y = 0;
                this.nextPiece = this.randomPiece();
                this.drawNext();
                if(this.collide(this.piece)) {
                    this.gameOver = true;
                    document.getElementById('gameover-modal').style.display = 'flex';
                }
            }

            collide(p) {
                for(let y=0; y<p.matrix.length; y++) {
                    for(let x=0; x<p.matrix[y].length; x++) {
                        if(p.matrix[y][x]!==0 && (this.board[y+p.y] && this.board[y+p.y][x+p.x])!==0) return true;
                    }
                }
                return false;
            }

            rotate() {
                if(!this.canRotate) return;
                const pos = this.piece.x;
                let offset = 1;
                this._rot(this.piece.matrix);
                while(this.collide(this.piece)) {
                    this.piece.x += offset;
                    offset = -(offset + (offset>0?1:-1));
                    if(offset > this.piece.matrix[0].length) {
                        this._rot(this.piece.matrix, -1);
                        this.piece.x = pos; return;
                    }
                }
                sound.play('move');
            }
            _rot(m, dir=1) {
                for(let y=0; y<m.length; ++y) for(let x=0; x<y; ++x) [m[x][y], m[y][x]] = [m[y][x], m[x][y]];
                if(dir>0) m.forEach(row=>row.reverse()); else m.reverse();
            }

            move(dir) {
                this.piece.x += dir;
                if(this.collide(this.piece)) this.piece.x -= dir;
                else sound.play('move');
            }

            drop() {
                this.piece.y++;
                if(this.collide(this.piece)) {
                    this.piece.y--;
                    this.merge();
                    sound.play('land');
                    this.sweep();
                    this.spawnPiece();
                }
                this.dropCounter = 0;
            }

            hardDrop() {
                while(!this.collide(this.piece)) this.piece.y++;
                this.piece.y--;
                this.merge();
                sound.play('land');
                this.sweep();
                this.spawnPiece();
            }

            merge() {
                this.piece.matrix.forEach((row, y) => {
                    row.forEach((v, x) => {
                        if(v!==0) {
                            let val = this.piece.color;
                            if(this.piece.type==='bomb') val=99;
                            if(this.piece.type==='diamond') val=88;
                            if(this.piece.type==='freeze') val=77;
                            this.board[y+this.piece.y][x+this.piece.x] = val;
                        }
                    });
                });
            }

            // ä¿®å¤ï¼šç»å¯¹ç¨³å¥çš„æ¶ˆé™¤é€»è¾‘
            sweep() {
                // filter è¿‡æ»¤å‡ºæ‰€æœ‰æœªæ»¡çš„è¡Œï¼ˆä¿ç•™ä¸‹æ¥ï¼‰
                let newBoard = this.board.filter(row => !row.every(cell => cell !== 0));
                // è®¡ç®—è¢«æ¶ˆé™¤çš„è¡Œæ•°
                let clearedCount = ROWS - newBoard.length;
                
                if (clearedCount > 0) {
                    sound.play('clear');
                    // åœ¨é¡¶éƒ¨è¡¥é½ç©ºè¡Œ
                    for(let i=0; i<clearedCount; i++) {
                        newBoard.unshift(new Array(COLS).fill(0));
                    }
                    // æ›´æ–°æ£‹ç›˜
                    this.board = newBoard;
                    
                    // ç‰¹æ•ˆ
                    if(this.vfxMode === 'thunder') {
                        document.getElementById('flash-overlay').classList.add('flashing');
                        setTimeout(()=>document.getElementById('flash-overlay').classList.remove('flashing'), 200);
                        this.canvas.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`; 
                        setTimeout(() => this.canvas.style.transform = 'none', 200);
                        for(let i=0; i<10; i++) this.particles.push(new Particle(150, 300, '#fff', 'normal'));
                    } 
                    else if(this.vfxMode === 'explode') {
                        this.canvas.style.transform = `scale(1.05)`;
                        setTimeout(() => this.canvas.style.transform = 'none', 300);
                    }

                    this.score += 100 * clearedCount;
                    if(this.mode === 'puzzle') {
                        setTimeout(()=>{ alert("å…³å¡å®Œæˆ! è¿›å…¥ä¸‹ä¸€å…³"); this.currentLevel++; this.reset('puzzle'); }, 500);
                    }
                    this.updateUI();
                }
            }

            addParticles(y, type, countMult) {
                for(let x=0; x<COLS; x++) {
                    const val = this.board[y][x];
                    if(val!==0) {
                        let c = COLORS[val] || '#fff';
                        if(val===99) c='red'; if(val===88) c='cyan';
                        let count = 5 * (countMult || 1);
                        for(let i=0; i<count; i++) this.particles.push(new Particle(x*30+15, y*30+15, c, type));
                    }
                }
            }

            update(time = 0) {
                const dt = time - this.lastTime;
                this.lastTime = time;

                if(!this.paused && !this.gameOver) {
                    if(this.mode === 'variant') {
                        this.variantTimer += dt;
                        if(this.variantTimer > 10000) {
                            this.variantTimer = 0;
                            const r = Math.random();
                            if(r<0.5) { this.dropInterval=200; this.showMsg("SPEED UP"); setTimeout(()=>{this.dropInterval=1000;}, 5000); }
                            else { this.canRotate=false; this.showMsg("NO ROTATE"); setTimeout(()=>{this.canRotate=true;}, 5000); }
                        }
                    }

                    this.dropCounter += dt;
                    if(this.dropCounter > this.dropInterval) this.drop();
                    
                    for(let i=this.particles.length-1; i>=0; i--) {
                        this.particles[i].update();
                        if(this.particles[i].life <= 0) this.particles.splice(i,1);
                    }

                    this.draw();
                }
                requestAnimationFrame(this.update.bind(this));
            }

            showMsg(txt) {
                const el = document.getElementById('msg-overlay');
                el.innerText = txt; el.style.opacity = 1;
                setTimeout(()=>el.style.opacity=0, 2000);
            }

            draw() {
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, 300, 600);

                if(this.mode !== '3d') {
                    this.ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                    this.ctx.lineWidth = 1;
                    for(let x=0; x<=300; x+=30) { this.ctx.beginPath(); this.ctx.moveTo(x,0); this.ctx.lineTo(x,600); this.ctx.stroke(); }
                    for(let y=0; y<=600; y+=30) { this.ctx.beginPath(); this.ctx.moveTo(0,y); this.ctx.lineTo(300,y); this.ctx.stroke(); }
                }

                let alpha = (this.mode === 'blind') ? 0.05 : 1.0;
                this.ctx.globalAlpha = alpha;
                
                for(let y=0; y<ROWS; y++) {
                    for(let x=0; x<COLS; x++) {
                        if(this.board[y][x] !== 0) this.drawBlock(x, y, this.board[y][x]);
                    }
                }

                this.ctx.globalAlpha = 1.0;
                if(this.piece) {
                    this.piece.matrix.forEach((row, y) => {
                        row.forEach((v, x) => {
                            if(v!==0) this.drawBlock(x+this.piece.x, y+this.piece.y, this.piece.color, this.piece.type);
                        });
                    });
                }

                this.particles.forEach(p => p.draw(this.ctx));
            }

            drawBlock(x, y, c, type) {
                let color = COLORS[c];
                if(!color) { if(c===99) color='red'; else if(c===88) color='cyan'; else color = '#888'; }
                const px = x*30; const py = y*30;
                const s = 30;

                if(this.mode === '3d') {
                    const d = 8; // æ·±åº¦
                    this.ctx.fillStyle = this.adjCol(color, -60);
                    this.ctx.beginPath();
                    this.ctx.moveTo(px+s, py);
                    this.ctx.lineTo(px+s+d, py-d);
                    this.ctx.lineTo(px+s+d, py+s-d);
                    this.ctx.lineTo(px+s, py+s);
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = this.adjCol(color, 40);
                    this.ctx.beginPath();
                    this.ctx.moveTo(px, py);
                    this.ctx.lineTo(px+d, py-d);
                    this.ctx.lineTo(px+s+d, py-d);
                    this.ctx.lineTo(px+s, py);
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = color;
                    this.ctx.fillRect(px, py, s, s);
                    this.ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                    this.ctx.strokeRect(px, py, s, s);
                } else {
                    if(this.blockStyle === 'magma') {
                        const grad = this.ctx.createLinearGradient(px, py, px+s, py+s);
                        grad.addColorStop(0, '#ffcc00'); grad.addColorStop(1, '#ff0000');
                        this.ctx.fillStyle = grad; this.ctx.fillRect(px, py, s, s);
                        this.ctx.strokeStyle = '#660000'; this.ctx.lineWidth = 2;
                        this.ctx.strokeRect(px, py, s, s);
                    } 
                    else if(this.blockStyle === 'ice') {
                        this.ctx.fillStyle = 'rgba(200, 255, 255, 0.4)'; this.ctx.fillRect(px+1, py+1, s-2, s-2);
                        this.ctx.strokeStyle = 'rgba(255,255,255,0.8)'; this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(px+2, py+2, s-4, s-4);
                        this.ctx.fillStyle = '#fff'; this.ctx.fillRect(px+4, py+4, 6, 6);
                    }
                    else if(this.blockStyle === 'brick') {
                        this.ctx.fillStyle = color; this.ctx.fillRect(px, py, s, s);
                        this.ctx.strokeStyle = 'rgba(0,0,0,0.5)'; this.ctx.lineWidth = 2;
                        this.ctx.beginPath();
                        this.ctx.moveTo(px, py+s/2); this.ctx.lineTo(px+s, py+s/2); 
                        this.ctx.moveTo(px+s/2, py); this.ctx.lineTo(px+s/2, py+s/2); 
                        this.ctx.stroke(); this.ctx.strokeRect(px,py,s,s);
                    }
                    else if(this.blockStyle === 'mech') {
                        const grad = this.ctx.createLinearGradient(px, py, px, py+s);
                        grad.addColorStop(0, '#888'); grad.addColorStop(0.5, '#ccc'); grad.addColorStop(1, '#666');
                        this.ctx.fillStyle = grad; this.ctx.fillRect(px+1, py+1, s-2, s-2);
                        this.ctx.fillStyle = '#333';
                        this.ctx.fillRect(px+2, py+2, 4, 4); this.ctx.fillRect(px+s-6, py+2, 4, 4);
                        this.ctx.fillRect(px+2, py+s-6, 4, 4); this.ctx.fillRect(px+s-6, py+s-6, 4, 4);
                        this.ctx.fillStyle = color; this.ctx.fillRect(px+8, py+8, s-16, s-16);
                    }
                    else {
                        this.ctx.fillStyle = color; this.ctx.fillRect(px+1, py+1, 28, 28);
                        this.ctx.fillStyle = 'rgba(255,255,255,0.3)'; this.ctx.fillRect(px+4, py+4, 22, 22);
                        this.ctx.fillStyle = color; this.ctx.fillRect(px+6, py+6, 18, 18);
                    }
                }

                if(type === 'bomb' || c===99) { this.ctx.fillStyle='#fff'; this.ctx.fillText('ğŸ’£', px+8, py+20); }
                if(type === 'diamond' || c===88) { this.ctx.fillStyle='#fff'; this.ctx.fillText('ğŸ’', px+8, py+20); }
                if(type === 'freeze' || c===77) { this.ctx.fillStyle='#fff'; this.ctx.fillText('â„ï¸', px+8, py+20); }
            }

            adjCol(color, amount) {
                return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
            }

            drawNext() {
                this.nextCtx.clearRect(0,0,60,60);
                if(this.nextPiece) {
                    const m = this.nextPiece.matrix;
                    const c = COLORS[this.nextPiece.color];
                    const s = 12; const ox = (60 - m[0].length*s)/2; const oy = (60 - m.length*s)/2;
                    this.nextCtx.fillStyle = c || '#fff';
                    m.forEach((row, y) => row.forEach((v, x) => {
                        if(v!==0) this.nextCtx.fillRect(ox+x*s, oy+y*s, s-1, s-1);
                    }));
                }
            }

            updateUI() {
                document.getElementById('score').innerText = this.score;
                document.getElementById('status-text').innerText = this.mode.toUpperCase().substring(0,4);
            }
            togglePause() { this.paused = !this.paused; }
            setMode(m) { this.mode = m; this.reset(); }
            setVfx(v) { this.vfxMode = v; }
            setBlockStyle(s) { this.blockStyle = s; }
            updateSettings() {
                const ctrl = document.getElementById('opt-control').value;
                document.getElementById('joystick').style.display = ctrl==='joystick'?'block':'none';
                document.getElementById('dpad-controls').style.display = ctrl==='buttons'?'grid':'none';
            }
            
            initInput() {
                document.addEventListener('keydown', e => {
                    if(this.paused || this.gameOver) return;
                    if(e.key==='ArrowLeft') this.move(-1);
                    if(e.key==='ArrowRight') this.move(1);
                    if(e.key==='ArrowDown') this.drop();
                    if(e.key==='ArrowUp') this.rotate();
                    if(e.key===' ') this.hardDrop();
                });

                const joy = document.getElementById('joystick');
                const stick = document.getElementById('stick');
                let startX=0, startY=0;
                
                const handleTouch = (x, y, mode) => {
                    if(mode === 'start') { startX=x; startY=y; }
                    else if(mode === 'move') {
                        let dx = x - startX, dy = y - startY;
                        let dist = Math.min(25, Math.hypot(dx, dy));
                        let angle = Math.atan2(dy, dx);
                        stick.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                        
                        if(Math.abs(dx) > 15 && !this.lockX) { 
                            this.move(dx>0?1:-1); this.lockX=true; setTimeout(()=>this.lockX=false, 150);
                        }
                        if(dy > 30 && !this.lockY) {
                            this.drop(); this.lockY=true; setTimeout(()=>this.lockY=false, 100);
                        }
                    } else stick.style.transform = `translate(0,0)`;
                };

                joy.addEventListener('touchstart', e=>{ 
                    if(document.body.classList.contains('layout-editing')) return; // ç¼–è¾‘æ¨¡å¼ç¦ç”¨æ¸¸æˆé€»è¾‘
                    e.preventDefault(); handleTouch(e.touches[0].clientX, e.touches[0].clientY, 'start'); 
                });
                joy.addEventListener('touchmove', e=>{ 
                    if(document.body.classList.contains('layout-editing')) return;
                    e.preventDefault(); handleTouch(e.touches[0].clientX, e.touches[0].clientY, 'move'); 
                });
                joy.addEventListener('touchend', e=>{ 
                    if(document.body.classList.contains('layout-editing')) return;
                    e.preventDefault(); handleTouch(0,0,'end'); 
                });

                const bind = (id, fn) => {
                    const el = document.getElementById(id);
                    el.addEventListener('touchstart', e => { 
                        if(document.body.classList.contains('layout-editing')) return; 
                        e.preventDefault(); e.stopPropagation(); fn(); 
                    });
                    el.addEventListener('mousedown', e => { 
                        if(document.body.classList.contains('layout-editing')) return;
                        e.stopPropagation(); fn(); 
                    });
                };
                bind('btn-rotate', ()=>this.rotate()); bind('btn-drop', ()=>this.hardDrop());
                bind('btn-left', ()=>this.move(-1)); bind('btn-right', ()=>this.move(1));
                bind('btn-up', ()=>this.rotate()); bind('btn-down', ()=>this.drop());
            }
        }

        // --- å¸ƒå±€ç¼–è¾‘ç³»ç»Ÿ ---
        const layoutSystem = {
            isEditing: false, activeEl: null, timer: null, initialDist: 0, initialScale: 1, config: {},
            init: () => {
                const saved = localStorage.getItem('tetris_layout');
                if(saved) { layoutSystem.config = JSON.parse(saved); layoutSystem.applyConfig(); }
                document.querySelectorAll('.draggable-item').forEach(el => {
                    el.addEventListener('touchstart', (e) => {
                        if(!layoutSystem.isEditing) return;
                        e.preventDefault(); e.stopPropagation();
                        if(e.touches.length === 2) {
                            layoutSystem.initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                            layoutSystem.initialScale = layoutSystem.getConfig(el.dataset.id).scale || 1;
                            return;
                        }
                        layoutSystem.timer = setTimeout(() => {
                            layoutSystem.activeEl = el; el.classList.add('active-drag');
                            if(navigator.vibrate) navigator.vibrate(50);
                        }, 500); 
                    }, {passive: false});
                    el.addEventListener('touchmove', (e) => {
                        if(!layoutSystem.isEditing) return;
                        e.preventDefault(); e.stopPropagation();
                        if(e.touches.length === 2 && layoutSystem.activeEl === el) {
                            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                            const scale = Math.max(0.5, Math.min(2.0, layoutSystem.initialScale * (dist / layoutSystem.initialDist)));
                            layoutSystem.updateConfig(el.dataset.id, { scale });
                            el.style.transform = `scale(${scale})`;
                            return;
                        }
                        if(layoutSystem.activeEl === el) {
                            const touch = e.touches[0];
                            const rect = document.getElementById('controls').getBoundingClientRect();
                            let x = touch.clientX - rect.left - (el.offsetWidth/2);
                            let y = touch.clientY - rect.top - (el.offsetHeight/2);
                            el.style.left = x + 'px'; el.style.top = y + 'px';
                            layoutSystem.updateConfig(el.dataset.id, { x, y });
                        } else clearTimeout(layoutSystem.timer);
                    }, {passive: false});
                    el.addEventListener('touchend', () => {
                        clearTimeout(layoutSystem.timer);
                        if(layoutSystem.activeEl) { layoutSystem.activeEl.classList.remove('active-drag'); layoutSystem.activeEl = null; }
                    });
                });
            },
            getConfig: (id) => layoutSystem.config[id] || {x:0, y:0, scale:1},
            updateConfig: (id, params) => { if(!layoutSystem.config[id]) layoutSystem.config[id] = {}; Object.assign(layoutSystem.config[id], params); },
            applyConfig: () => {
                if(Object.keys(layoutSystem.config).length > 0) {
                    document.body.classList.add('custom-layout');
                    for(let id in layoutSystem.config) {
                        const el = document.querySelector(`.draggable-item[data-id="${id}"]`);
                        if(el) {
                            const conf = layoutSystem.config[id];
                            if(conf.x !== undefined) { el.style.position = 'absolute'; el.style.left = conf.x + 'px'; el.style.top = conf.y + 'px'; }
                            if(conf.scale !== undefined) el.style.transform = `scale(${conf.scale})`;
                        }
                    }
                }
            },
            startEdit: () => {
                ui.closeAll(); layoutSystem.isEditing = true;
                document.body.classList.add('layout-editing', 'custom-layout');
                document.getElementById('layout-editor-overlay').style.display = 'block';
            },
            saveAndExit: () => {
                layoutSystem.isEditing = false; document.body.classList.remove('layout-editing');
                document.getElementById('layout-editor-overlay').style.display = 'none';
                localStorage.setItem('tetris_layout', JSON.stringify(layoutSystem.config));
            },
            resetDefault: () => {
                layoutSystem.config = {}; localStorage.removeItem('tetris_layout');
                document.body.classList.remove('custom-layout');
                document.querySelectorAll('.draggable-item').forEach(el => { el.style.position = ''; el.style.left = ''; el.style.top = ''; el.style.transform = ''; });
                layoutSystem.saveAndExit();
            }
        };

        class Particle {
            constructor(x, y, color, type) {
                this.x = x; this.y = y; this.color = color; this.life = 1.0;
                if(type === 'fast') { 
                    const a = Math.random() * 6.28; const s = Math.random() * 10 + 5;
                    this.vx = Math.cos(a)*s; this.vy = Math.sin(a)*s; this.size=4; this.decay=0.03; 
                } else if(type === 'float') {
                    this.vx = (Math.random()-0.5)*2; this.vy = -Math.random()*3; this.size=6; this.decay=0.015; this.isStar=true;
                } else {
                    this.vx = (Math.random()-0.5)*5; this.vy = Math.random()*5; this.size=5; this.decay=0.02;
                }
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                if(!this.isStar) this.vy += 0.4;
                this.life -= this.decay;
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
                if(this.isStar) { 
                    ctx.translate(this.x, this.y); ctx.rotate(Date.now()/100); ctx.fillRect(-3,-3,6,6); 
                } else ctx.fillRect(this.x, this.y, this.size, this.size);
                ctx.restore();
            }
        }

        const ui = {
            openSettings: () => { game.paused=true; document.getElementById('settings-modal').style.display='flex'; },
            openRules: () => { game.paused=true; document.getElementById('rules-modal').style.display='flex'; },
            openLevels: () => {
                game.paused=true; const list = document.getElementById('level-list'); list.innerHTML='';
                for(let i=1; i<=100; i++) {
                    let d = document.createElement('div'); d.className='lvl-item'; d.innerText=i;
                    d.onclick = () => { game.currentLevel=i; game.reset('puzzle'); ui.closeAll(); };
                    list.appendChild(d);
                }
                document.getElementById('levels-modal').style.display='flex';
            },
            closeAll: () => { document.querySelectorAll('.modal').forEach(x=>x.style.display='none'); game.paused=false; game.updateSettings(); },
            updateTheme: () => { document.body.setAttribute('data-theme', document.getElementById('opt-theme').value); },
            updateFont: (font) => { document.documentElement.style.setProperty('--font-current', font); }
        };

        const startBtn = document.getElementById('start-btn');
        const loader = document.getElementById('loader');
        const fill = document.getElementById('progress-fill');
        const per = document.getElementById('percent');
        const bootScreen = document.getElementById('boot-screen');

        startBtn.addEventListener('click', () => {
            sound.init(); 
            startBtn.style.display = 'none';
            loader.style.display = 'flex';
            sound.play('intro');

            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 3; 
                if(progress > 100) progress = 100;
                fill.style.width = progress + '%';
                per.innerText = Math.floor(progress) + '%';
                
                if(progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        bootScreen.style.opacity = 0;
                        setTimeout(() => {
                            bootScreen.style.display = 'none';
                            // å¯åŠ¨æ—¶æ˜¾ç¤ºä¾§è¾¹æ 
                            document.querySelector('.side-menu').style.display = 'flex';
                            window.game = new Game();
                            layoutSystem.init();
                        }, 500);
                    }, 500);
                }
            }, 30);
        });
        
        setInterval(()=>document.getElementById('clock').innerText=new Date().toTimeString().substr(0,5), 1000);

    </script>
</body>
</html>